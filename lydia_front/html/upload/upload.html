<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <label for="upload">上传</label>
    <input type="file" id="upload" multiple>

    <button id="submit">提交</button>

    <img src="" alt="">
</body>

<script src="../js/axios.min.js"></script>
<script src="../js/request.js"></script>

<script>

    let uploadInput = document.querySelector('#upload')
    let submitBtn = document.querySelector('#submit')
    let img = document.querySelector('img')
    let uploadUrl = null

    uploadInput.onchange = async function () {
        let file = uploadInput.files[0]

        if (!file) {
            return alert('未选择文件')
        }

        let src = window.URL.createObjectURL(file)
        img.src = src;

        // let reader = new FileReader()

        // reader.onload = function () {
        //     img.src = reader.result;
        // }

        // reader.readAsDataURL(file)


    }

    submitBtn.onclick = async function () {
        let baseSize = 1024 * 1024 * 1; // 1m

        let file = uploadInput.files[0]

        if (!file) {
            return alert('未选择文件')
        }

        if (file.size < baseSize) {
            console.log('小文件上传');
            return
        }

        // let formData = new FormData();
        // formData.append('file', file)

        // let data = await uploadFile(formData)
        // uploadUrl = data;
        // img.src = `http://localhost:4400${data}`

        // 大文件分片上传
        console.log('大文件上传');
        console.log(file.size);

        let chunkList = [];
        let cueSize = 0;

        while (cueSize <= file.size) {

            chunkList.push(file.slice(cueSize, cueSize + baseSize))

            cueSize += baseSize;
        }

        let ms = Date.now();

        let chunkMap = chunkList.map((chunk, i) => {
            let formData = new FormData();
            formData.append('file', chunk)

            return uploadChunk(formData, { name: `${ms}`, index: i })
        })

        await Promise.all(chunkMap)

        let fileUrl = await mergeFile({ filename: file.name, name: ms, size: baseSize })



    }


</script>

</html>